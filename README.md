# Docs

# Начало работы

Данный микросервис позволяет производить манипуляции с данными сканирования, получая запросы и отправляя ответы через брокера сообщений RabbitMQ.

Реализованы следующие операции с файлами:

- Распаковка данных сканирования из файла .bag в облако точек формата .ply,
- Конвертация из файла .ply в формат .xyz,
- Смена осей в облаке,
- Поворот облака на заданный угол,
- Окрашивание облака.

# Деплой приложения

Описан манифест для Kubernetes Pod, который создает Pod с двумя контейнерами: контейнер с RabbitMQ и контейнер с самим микросервисом.

Контейнер для RabbitMQ использован стандартный. Создается и запускается командой:

```bash
docker run -it --rm --name CONTAINERNAME -p 5672:5672 -p
15672:15672 rabbitmq:3.12-management
```

Для создания контейнера микросервиса описан Dockerfile, который создается командой:

```bash
docker build -f Dockerfile -t CONTAINERNAME .
```

Для запуска контейнера используется следующая команда:

```bash
docker run -it CONTAINERNAME
```

# Зависимости

Для запуска микросервиса необходимо установить следующие зависимости, также описанные в файле requirements.txt:

- **aio-pika** версии 9.3.1,
- **jsondiff** версии 2.0.0,
- **loguru** версии 0.7.2,
- **pytest** версии 7.4.3,
- **pytest-asyncio** версии 0.23.2,
- **python-dotenv** версии 1.0.0,
- **pydantic** версии 2.5.3.

# receive.py

### Метод **create_request_queue()**

Метод создаёт очередь в брокере сообщений, которая может принимать либо отравлять запросы.

Возвращает результат типа **AbstractQueue** из пакета **aio-pika.abc**.

# send.py

### Метод **create_message(response_query, message_id)**

Генерирует запрос для выходной очереди брокера. Принимает следующие параметры:

- **response_query (ResponseQuery)** – содержимое запроса,
- **message_id** **(str)** – идентификатор сообщения.

Возвращает результат типа **Message** из пакета **aio-pika**.

### Метод **send_response_query(response_query, message_id)**

Отправляет запрос в выходную очередь брокера. Принимает следующие параметры:

- **response_query** **(ResponseQuery)** – содержимое запроса,
- **message_id (str)** – идентификатор сообщения.

Возвращает результат типа **bool**.

# log.py

### Метод **start_log(log_file_path)**

Запускает процесс логирования. Принимает аргумент:

- **log_file_path** **(str)** – расположение файла лога. По умолчанию принимает значение “logfile.log”.

# entities.py

### Класс **RequestUnbagQuery**

Наследуется от класса **BaseModel** из модуля **pydantic**. Является абстрактным представлением входящего запроса на распаковку данных из .bag в облако точек .ply. Имеет следующие поля:

- **id** **(uuid.UUID)** – идентификатор операции,
- **operation_type** **(str)** – тип операции,
- **files (list(str))** – директория с файлами для обработки,
- **output_path** **(str)** – директория для расположения получившегося файла облака точек,
- **params** **(dict)** – параметры операции.

### Класс **RequestUnbagQuery**

Наследуется от класса **BaseModel** из модуля **pydantic**. Является абстрактным представлением входящего запроса на любую обработку файлов, кроме распаковки. Имеет следующие поля:

- **id** **(uuid.UUID)** – идентификатор операции,
- **operation_type** **(str)** – тип операции,
- **file (str)** – директория с файлом для обработки,
- **output_path** **(str)** – директория для расположения получившегося файла облака точек,
- **params** **(dict)** – параметры операции.

### Класс **ResponseQuery**

Наследуется от класса **BaseModel** из модуля **pydantic**. Является абстрактным представлением отправляемого ответа. Имеет следующие поля:

- **id** **(uuid.UUID)** – идентификатор операции,
- **operation_type** **(str)** – тип операции,
- **file (str)** – директория с файлом для обработки.

# pointcloud_handlers.py

### Метод **get_axis_swap(query, filename)**

Производит смену осей в облаке точек. Принимает следующие параметры:

- **query (RequestQuery)** – запрос на выполнение операции,
- **filename** **(str)** – имя файла результата.

Возвращает результат типа **ResponseQuery**.

### Метод **get_axiswise_rot(query, filename)**

Производит поворот облака точек на заданный угол. Принимает следующие параметры:

- **query (RequestQuery)** – запрос на выполнение операции,
- **filename** **(str)** – имя файла результата.

Возвращает результат типа **ResponseQuery**.

### Метод **get_conv_ply_xyz(query, filename)**

Производит конвертацию облака точек. Принимает следующие параметры:

- **query (RequestQuery)** – запрос на выполнение операции,
- **filename** **(str)** – имя файла результата.

Возвращает результат типа **ResponseQuery**.

### Метод **get_height_color(query, filename)**

Производит конвертацию облака точек. Принимает следующие параметры:

- **query (RequestQuery)** – запрос на выполнение операции,
- **filename** **(str)** – имя файла результата.

Возвращает результат типа **ResponseQuery**.

### Метод **get_unbag(query, filename)**

Производит распаковку файла данных сканирования в облако точек. Принимает следующие параметры:

- **query (RequestUnbagQuery)** – запрос на выполнение операции,
- **filename** **(str)** – имя файла результата.

Возвращает результат типа **ResponseQuery**.

# main.py

### Метод **on_message(message)**

Обрабатывает сообщения из очереди. В качестве аргумента принимает:

- **message (Message)** – сообщение из входящей очереди брокера.

Не возвращает результата.

### Метод **get_operations(request_query, filename)**

Выполняет операции над файлами. Передает данные в соответствующий обработчик из модуля pointcloud_handlers. Принимает следующие аргументы:

- **request_query (RequestQuery | RequestUnbagQuery)** – запрос на выполнение операции,
- **filename** **(str)** – имя файла результата.

Возвращает результат типа **ResponseQuery**.

### Метод **correct_request(request_query, waiting_response)**

Проверяет совпадают ли ожидаемые и реальные значения в запросе. Принимает следующие аргументы:

- **request_query (RequestQuery | RequestUnbagQuery)** - запрос на выполнение операции,
- **waiting_response (ResponseQuery)** - ожидаемый ответ

Возвращает результат типа **bool**.

### Метод **processing(data)**

Выполняет обработку запроса. Принимает аргумент: 

- **data** **(dict)** – данные запроса.

Возвращает результат типа **bool** либо **tuple[ResponseQuery]**.

### Метод **main()**

Основная функция приложения. Запускает работу микросервиса. Не возвращает результата.